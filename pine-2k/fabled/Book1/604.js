save("save/bookmark", "Book1/604.js");

const MARK = 0;
const GOTO = 1;
const text = [
MARK,
`

  The men mutter among themselves
at your decision, but you insist.
The sea centaur lies barely able
to move on the deck. Nor does it
speak.

  That night, you see a strange
glow rising up out of the depths.
The sailors back away, muttering
superstitiously, as several sea
centaurs emerge from the waters,
their spiny skins glittering with
phosphorescent flashes of light.

  One of the sea centaurs asks in a
burbling voice, 'Where is our
brother, whom you caught in your
cruel nets, this day?'`,
MARK,
`
  'Why, here he is,' you say,
indicating the half-conscious sea
centaur on deck.

  'Return him to us, we beg you,'
one of them warbles.

  Your men, anxious to be rid of
the creature, hand him down to his
friends.

  'We thank you, landwalkers,' says
the leader.

  He gives you a x {uses} . When
you blow it, it confers the
blessing of Safety from Storms. It
can be used three times only (each
time you use it reduce the number`,
MARK,
`of charges by one). When it is out
of charges, it has become useless
- cross it off your Adventure
Sheet.

  `,
GOTO,
"Book1/507.js",
`go to 507`,
`.`,
MARK
];

const funcs = new Array(5);
funcs[MARK] = f_mark;
funcs[GOTO] = f_goto;

window(0, 0, 220, 176);
io("FILLER", 3, "TEXT", "5x7");
io("FORMAT", 0, 0);

var index, selection = 0;
var position = 1, mark = 0;
var isLastMark = false;



render();

function f_mark(){
    position = index + 1;
    mark = index;
}

function f_goto(trigger){
    var page = text[index + 1];
    var caption = text[index + 2];
    var selected = ((index - mark) == selection);
    if(selected) print("[");
    else print(" ");
    print(caption);
    if(selected) print("]");
    else print(" ");

    index += 2;

    if(trigger){
        position = -1;
        splash(0, 0, "splash.565");
        window(0, 166, 220, 176);
        io("CLEARTEXT");
        cursor(1, 21);
        print(caption);
        exec(page);
    }
}

function isText(i){
    var line = text[i];
    return line < 0 || line >= length(funcs);
}

function render(){
    if(position < 0)
        return;
    io("CLEARTEXT");
    fill(0);
    cursor(0,0);
    color(32);
    index = position;
    for(; text[index] != MARK; ++index){
        var line = text[index];
        if(isText(index)) print(line);
        else funcs[line](false);
    }
    isLastMark = index == length(text) - 1;
    color(7);
}

function update(){
    if(justPressed("C"))
        exit();

    if(justPressed("A")){
        index = mark + selection;
        funcs[text[index]](true);
        render();
    }

    if(!isLastMark){
        flip(true);
        sprite(220-8, 176-8, builtin("cursor2"));
    }

    var direction = justPressed("DOWN") - justPressed("UP");
    if(direction == 0){
        return;
    }
    var prevPrev = 0;
    var prevMark = 0;
    var prevSelection = -1;
    var curSelection = -1;
    var absSelection = mark + selection + (direction > 0);
    index = (mark + selection) * (direction > 0);
    for( ; (prevSelection != absSelection) && (isText(curSelection) || curSelection < absSelection); ++index){
        if(index >= length(text)) return;
        if(isText(index)) continue;
        prevSelection = curSelection;
        curSelection = index;
        var line = text[index];
        if(line != MARK){
            funcs[line](false);
        } else {
            prevPrev = prevMark;
            prevMark = index;
        }
    }

    if(direction > 0){
        index = curSelection;
    }else{
        if(prevSelection < mark){
            if(mark == 0)
                return;
            index = prevPrev;
            funcs[MARK](false);
        }
        index = prevSelection;
    }

    if(text[index] == MARK){
        if(isLastMark && direction > 0){
            render();
            return;
        }
        selection = 0;
    }else
        selection = index - mark;

    funcs[text[index]](false);

    render();
}
